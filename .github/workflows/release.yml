name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build Windows
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            artifact_name: dota2-scripts.exe

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Generate Cargo.lock
        run: cargo generate-lockfile

      - name: Cache cargo registrycies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package artifact with config
        shell: pwsh
        run: |
          $VERSION = "${{ github.ref_name }}"
          $PACKAGE_DIR = "artifacts/dota2-scripts-${VERSION}-windows-x64"
          
          # Create package directory structure
          New-Item -ItemType Directory -Force -Path $PACKAGE_DIR
          New-Item -ItemType Directory -Force -Path "$PACKAGE_DIR/config"
          
          # Copy executable and config
          Copy-Item "target/${{ matrix.target }}/release/${{ matrix.artifact_name }}" -Destination "$PACKAGE_DIR/dota2-scripts.exe"
          Copy-Item "config/config.toml" -Destination "$PACKAGE_DIR/config/config.toml"
          
          # Create ZIP archive
          Compress-Archive -Path "$PACKAGE_DIR/*" -DestinationPath "artifacts/dota2-scripts-${VERSION}-windows-x64.zip" -Force
          
          Write-Host "Package contents:"
          Get-ChildItem -Recurse $PACKAGE_DIR

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dota2-scripts-${{ github.ref_name }}-windows-x64
          path: artifacts/dota2-scripts-${{ github.ref_name }}-windows-x64.zip

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Generate changelog
        id: changelog
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          echo "Current tag: $CURRENT_TAG"
          
          # Determine comparison tag based on version type
          if [[ "$CURRENT_TAG" =~ -rc\.([0-9]+)$ ]]; then
            # This is an RC release
            RC_NUM="${BASH_REMATCH[1]}"
            BASE_VERSION=$(echo "$CURRENT_TAG" | sed 's/-rc\.[0-9]*$//')
            
            if [ "$RC_NUM" -eq 1 ]; then
              # First RC: compare with previous stable
              COMPARE_TAG=$(git tag -l 'v*' | grep -v '\-rc' | sort -V | tail -n1)
              COMPARE_TYPE="stable release"
            else
              # Subsequent RC: compare with previous RC
              PREV_RC=$((RC_NUM - 1))
              COMPARE_TAG="${BASE_VERSION}-rc.${PREV_RC}"
              COMPARE_TYPE="previous RC"
            fi
          else
            # This is a stable release: compare with previous stable
            COMPARE_TAG=$(git tag -l 'v*' | grep -v '\-rc' | grep -v "^${CURRENT_TAG}$" | sort -V | tail -n1)
            COMPARE_TYPE="stable release"
          fi
          
          echo "Comparing with: $COMPARE_TAG ($COMPARE_TYPE)"
          echo "compare_tag=$COMPARE_TAG" >> $GITHUB_OUTPUT
          echo "compare_type=$COMPARE_TYPE" >> $GITHUB_OUTPUT
          
          # Generate changelog
          if [ -n "$COMPARE_TAG" ] && git rev-parse "$COMPARE_TAG" >/dev/null 2>&1; then
            echo "Generating changelog from $COMPARE_TAG to $CURRENT_TAG"
            
            # Get commits grouped by type
            FEATURES=$(git log ${COMPARE_TAG}..${CURRENT_TAG} --pretty=format:"- %s" --grep="^feat" --extended-regexp | head -20)
            FIXES=$(git log ${COMPARE_TAG}..${CURRENT_TAG} --pretty=format:"- %s" --grep="^fix" --extended-regexp | head -20)
            OTHER=$(git log ${COMPARE_TAG}..${CURRENT_TAG} --pretty=format:"- %s" --grep="^\(chore\|docs\|refactor\|perf\|test\|build\|ci\|style\)" --extended-regexp | head -10)
            
            # Build changelog markdown
            CHANGELOG=""
            
            if [ -n "$FEATURES" ]; then
              CHANGELOG="${CHANGELOG}#### ‚ú® New Features\n${FEATURES}\n\n"
            fi
            
            if [ -n "$FIXES" ]; then
              CHANGELOG="${CHANGELOG}#### üêõ Bug Fixes\n${FIXES}\n\n"
            fi
            
            if [ -n "$OTHER" ]; then
              CHANGELOG="${CHANGELOG}#### üîß Other Changes\n${OTHER}\n\n"
            fi
            
            if [ -z "$CHANGELOG" ]; then
              # Fallback: show all commits if no conventional commits found
              ALL_COMMITS=$(git log ${COMPARE_TAG}..${CURRENT_TAG} --pretty=format:"- %s" | head -20)
              if [ -n "$ALL_COMMITS" ]; then
                CHANGELOG="#### üìù Changes\n${ALL_COMMITS}\n\n"
              else
                CHANGELOG="No changes detected.\n"
              fi
            fi
            
            # Add comparison link
            CHANGELOG="${CHANGELOG}**Full Changelog**: https://github.com/${{ github.repository }}/compare/${COMPARE_TAG}...${CURRENT_TAG}"
          else
            CHANGELOG="Initial release.\n\n**Full Changelog**: https://github.com/${{ github.repository }}/commits/${CURRENT_TAG}"
          fi
          
          # Save to file (handles multiline)
          echo -e "$CHANGELOG" > changelog.md
          echo "Changelog generated:"
          cat changelog.md

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Prepare release body
        run: |
          cat << 'HEADER' > release_body.md
          ## Dota2 Scripts ${{ github.ref_name }}
          
          ${{ contains(github.ref, '-rc') && '‚ö†Ô∏è **This is a Release Candidate** - Not recommended for production use. Please test and report issues.' || '' }}
          
          ### üìã Changelog (compared to ${{ steps.changelog.outputs.compare_tag }})
          
          HEADER
          
          cat changelog.md >> release_body.md
          
          cat << 'FOOTER' >> release_body.md
          
          ---
          
          ‚ö†Ô∏è **WARNING**: Using game automation scripts may violate Terms of Service and result in account bans. Use at your own risk!
          
          ### üì• Downloads
          - **Windows**: `dota2-scripts-${{ github.ref_name }}-windows-x64.zip` (includes exe + config)
          
          ### üìã Requirements
          - Windows 10/11
          - Administrator privileges (UAC prompt will appear on launch)
          - Dota 2 with GSI configured
          
          ### ‚ö° Features
          - Automatic armlet toggling
          - Hero-specific combos (Huskar, Legion Commander, Shadow Fiend, Tiny)
          - GSI event-based automation
          - Standalone hotkey triggers
          
          See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for setup and usage instructions.
          FOOTER
          
          echo "Final release body:"
          cat release_body.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/dota2-scripts-${{ github.ref_name }}-windows-x64/dota2-scripts-${{ github.ref_name }}-windows-x64.zip
          body_path: release_body.md
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
